<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Budget Bot">
    <link rel="stylesheet" type="text/css" href="css/login.css" />
    <title>Budget Bot</title>
</head>
<body>

<!-- source: https://codepen.io/colorlib/pen/rxddKy -->
<div class="login-page">
  <div class="form">
    <form class="register-form" onsubmit="signup(); return false;">
      <input type="text" placeholder="username" id="user1"/>
      <input type="text" placeholder="email" id="email1"/>
      <input type="password" placeholder="password" id="password1"/>
      <button>create</button>
      <p class="message">Already registered? <a href="#">Sign In</a></p>
    </form>
    <form class="login-form" onsubmit="login(); return false;">
      <input type="text" placeholder="username" id="user2"/>
      <input type="password" placeholder="password" id="password2"/>
      <button>login</button>
      <p class="message">Not registered? <a href="#">Create an account</a></p>
    </form>
  </div>
</div>
<script
        src="//code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script>
var host = "https://api.tellbudgetbot.com";
$('.message a').click(function(){
   $('form').animate({height: "toggle", opacity: "toggle"}, "slow");
});
function login(){
  var user = document.getElementById("user2").value;
  var pass = document.getElementById("password2").value;
  $.post(host+"/login", {"user":user,"pass":pass}, function( data ) {
    if(data.error === undefined ) {
      redir(user,data);
    } else {
      alert(data.error);
    }
  },"json").fail(function() {
    console.log('Error');
  });
}
function signup(){
  var user = document.getElementById("user1").value;
  var email = document.getElementById("email1").value;
  var pass = document.getElementById("password1").value;
  $.post(host+"/signup", {"user":user,"email":email,"pass":pass}, function( data ) {
    if(data.error === undefined) {
      redir(user,data);
    } else {
      alert(data.error)
    }
  },"json").fail(function() {
    console.log('Error');
  });
}
function startsWith(str,start){
  return str.length >= start.length && str.substr(0,start.length) == start;
}
function is_valid_redirect(redirect_uri) {
  var uris = ["https://pitangui.amazon.com/spa/skill/account-linking-status.html?vendorId=M1MY1UQEEEFTLT",
              "https://layla.amazon.com/spa/skill/account-linking-status.html?vendorId=M1MY1UQEEEFTLT",
              "https://alexa.amazon.co.jp/spa/skill/account-linking-status.html?vendorId=M1MY1UQEEEFTLT"];
  for(var i = 0;  i < uris.length; i++) {
    if(redirect_uri == uris[i]){
      return true;
    }
  }
  if(startsWith(redirect_uri, "https://facebook.com/messenger_platform/account_linking/")) {
    return true;
  }
  return false;
}
function redir(user,data){
  if(window.location.search.indexOf("alexa")!==-1){
		var url = window.location.href;
		var state = getParameterByName("state", url);
		var client_id = getParameterByName("client_id", url);
		var response_type = getParameterByName("response_type", url);
		var scope = getParameterByName("scope", url);
		var redirect_uri = getParameterByName("redirect_uri", url);
    if(client_id == "alexa" && is_valid_redirect(redirect_uri)) {
      document.location.href=redirect_uri+"#state="+state+"&access_token="+data.token+"&token_type=Bearer";
      return;
    }
  } else if(window.location.search.indexOf("messenger")!==-1) {
		var url = window.location.href;
		var link_token = getParameterByName("account_linking_token", url);
		var client_id = getParameterByName("client_id", url);
		var redirect_uri = getParameterByName("redirect_uri", url);
    if(client_id == "messenger" && is_valid_redirect(redirect_uri)) {
      document.location.href=redirect_uri + "&authorization_code="+data.token;
      return;
    }
  }
  localStorage.setItem("user",user);
  localStorage.setItem("userid",data.userid);
  localStorage.setItem("token",data.token);
  document.location.href="index.html";
}
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
</script>
</body>
</html>
